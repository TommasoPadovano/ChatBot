<html>
  <head>
    <title>Simple ChatAI using RiveScript.js</title>
    <link rel="stylesheet" href="/styles/style.css">
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
  </head>
  <body>
    <div class="chat">
      <div class="messages"></div>
      <div id="edge"></div>
      <form class="actions">
        <input type="text" placeholder="press Enter to sendâ€¦">
      </form> 
    </div>
 
    <script src="https://unpkg.com/rivescript@latest/dist/rivescript.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded',init);

        let bot;
        let message_container;
        let info_box;
        let form;
        let brains;

        function init() {
          bot = new RiveScript();
          brains = [];

          getPreviousChat(15);
          setUpBot();
        }

        function getPreviousChat(numOfMessages) {
          let myHeaders = new Headers();
          myHeaders.append('Content-Type', 'application/json');
          let myInit = { 
            method: 'GET',
            headers: myHeaders,
          };
          fetch(`/${numOfMessages}`, myInit)
          .then((httpResponse)=>{
            return httpResponse.json();
          })
          .then((data)=>{
            // Manage the retrieve messages
            data.forEach((tuple) => {
              oldSelfReply(tuple.user_msg);
              botReply(tuple.bot_answer);
            })
          })
          .catch((err)=>{
            console.log(`ERROR : ${err}`);
          })
        }

        function setUpBot() {
          let myHeaders = new Headers();
          myHeaders.append('Content-Type', 'application/json');
          let myInit = { 
            method: 'GET',
            headers: myHeaders,
          };
          
          // Launch the request
          fetch('/bot', myInit)
            .then((httpResponse)=>{
              return httpResponse.text();
            })
            .then((responseBody)=>{
              botInfo = JSON.parse(responseBody);
              console.log(botInfo.brains);
    
              // Add all the brains of our bot
              // NOTE: we have to test if the bot actually works with more than one brain
              botInfo.brains.forEach((brain) => {
                console.log('Adding: ' + '/data/' + brain)
                brains.push('/data/' + brain);
              })
              // Load the brains and then call botReady
              bot.loadFile(brains).then(botReady).catch(botNotReady); // load the brains

              message_container = document.querySelector('.messages');
              form = document.querySelector('form');
              input_box = document.querySelector('input');
              form.addEventListener("submit", (e) => {
                e.preventDefault();
                selfReply(input_box.value);
                input_box.value = "";
              });
              console.log(`response is ${responseBody}`);
            })
            .catch((err)=>{
              console.log(`ERROR : ${err}`);
            })
        }

        function botReply(message){
          // Display the bot answer in the chat
          message_container.innerHTML += `<div class="bot">${message}</div>`;
          location.href = "#edge";
        }

        function oldSelfReply(message) {
          // Display the old user message in the chat
          message_container.innerHTML += `<div class="self">${message}</div>`;
          location.href = "#edge";
        }

        function selfReply(message){
          // Display the user message in the chat
          message_container.innerHTML += `<div class="self">${message}</div>`;
          location.href = "#edge";
          
          // Bot reply
          bot.reply("local-user", message).then(function(reply) {
            botReply(reply);

            // Save the user message and the bot's reply in the db
            let headers = new Headers();
            headers.append('Content-Type', 'application/json');

            let payload = {
              message: message,
              reply: reply
            }
            let myBody = JSON.stringify(payload);

            let init = { 
              method: 'POST',
              headers: headers,
              body: myBody,
            };

            fetch('/chat', init)
              .then((httpResponse) => {
                return httpResponse.text()
              })
              .catch((err)=>{
                console.log(`ERROR : ${err}`);
              })
          });
        }
        function botReady(){
          bot.sortReplies();
          //botReply("Hello");
        }
        function botNotReady(err){
        }
    </script>
  </body>
</html>