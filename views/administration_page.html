<html>
    <head>
        <title>Administration Page for ChatBot</title>
        <link rel="stylesheet" href="/styles/style_admin.css">

        <!-- CSS Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

        <!-- JS Bootstrap -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
    </head>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="administration_page.html">ChatBot</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item active">
              <a class="nav-link" href="administration_page.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="login.html" id="login-link">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logout-link">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <body class="general_body">
      <div class="search-container">
        <form class="search-form" action="#">
          <input type="text" placeholder="Search...">
          <button type="submit">Search</button>
        </form>
      </div>
        <div class="container">
            <form class="creation-form">
                <h1>Bot Creation</h1>
                <label for="bot-image">Bot image:</label>
                <div class="image-carousel">
                    <input type="radio" name="bot-image" id="image1" value="image1.png">
                    <label for="image1"><img src="/images/image1.png" alt="Image 1"></label>
                    
                    <input type="radio" name="bot-image" id="image2" value="image2.png">
                    <label for="image2"><img src="/images/image2.png" alt="Image 2"></label>
                    
                    <input type="radio" name="bot-image" id="image3" value="image3.png">
                    <label for="image3"><img src="/images/image3.png" alt="Image 3"></label>
                    
                    <input type="radio" name="bot-image" id="image4" value="image4.png">
                    <label for="image4"><img src="/images/image4.png" alt="Image 4"></label>
                    
                    <input type="radio" name="bot-image" id="image5" value="image5.png">
                    <label for="image5"><img src="/images/image5.png" alt="Image 5"></label>
                </div>
                <label for="bot-name">Bot name: </label>
                <input type="text" id="bot-name" name="bot-name" placeholder="Insert the name...">
                <label for="bot-file">Brains: </label>
                <select id="bot-file" name="bot-file">
                    <option value="Standard.rive">Standard.rive</option>
                    <option value="Comments.rive">Comments.rive</option>
                    <option value="Replies.rive">Replies.rive</option>
                </select>
                <label>Selected brains:</label>
                <ol id="selected-brains"></ol>
                <br>
                <label for="bot-status">Status: </label><br>
                <label><input type="radio" name="status_choice" value="active"> Active </label>
                <label><input type="radio" name="status_choice" value="inactive"> Inactive </label>
                <br><br>
                <label for="bot-mouths">Active also on: </label><br>
                <input type="checkbox" id="checkbox1" name="checkbox" value="discord">
                <label for="checkbox1"><img class="mouth" src="/images/discord.png" alt="Discord" /></label>
                <input type="checkbox" id="checkbox2" name="checkbox" value="slack">
                <label for="checkbox2"><img class="mouth" src="/images/slack.png" alt="Slack" /></label>
                <input type="checkbox" id="checkbox3" name="checkbox" value="mastodon">
                <label for="checkbox3"><img class="mouth" src="/images/mastodon.png" alt="Mastodon" /></label>
                <br>
                <button class="create-button" type="submit">Create Bot</button>
            </form>
            
            <br>

            <h2>Existing bots:</h2> <br>
            <div id="carouselIndicators" class="carousel slide" data-ride="carousel">  
                <div class="carousel-inner">
                </div>
                <br><br>
                <ol class="carousel-indicators">
                </ol>
                <a class="carousel-control-prev" href="#carouselIndicators" role="button" data-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselIndicators" role="button" data-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="sr-only">Next</span>
                </a>
              </div>
        </div> 
    </body>
    <script>
        document.addEventListener('DOMContentLoaded',init);

        let botList;
        let createNewBotButton;
        let chosen_image1;
        let chosen_image2;
        let chosen_image3;
        let chosen_image4;
        let chosen_image5;
        let botName;
        let selected;


        function manageFilesInCreation() {
          const select = document.getElementById("bot-file");
          const list = document.getElementById("selected-brains");

          select.addEventListener("change", function() {
              const selectedOption = this.options[this.selectedIndex];
              if (!selected.includes(selectedOption.value)) {
                  selected.push(selectedOption.value);
                  const listItem = document.createElement("li");
                  listItem.textContent = selectedOption.textContent;
                  list.appendChild(listItem);
              }
          });
        }

        function createNewBot() {
          const radioButtons = document.getElementsByName('bot-image');
          let selectedImage = 'image1.png'; //default value

          for (let i = 0; i < radioButtons.length; i++) {
            if (radioButtons[i].checked) {
              selectedImage = radioButtons[i].value;
              break;
            }
          }

          const checkboxButtons = document.getElementsByName('checkbox');
          let mouths = [];
          for(let j = 0; j < checkboxButtons.length; j++) {
            if(checkboxButtons[j].checked) {
              mouths.push(checkboxButtons[j].value);
            }
          }

          let status = 'active';
          const options = document.getElementsByName('status_choice');
          for (let i = 0; i < options.length; i++) {
            if (options[i].checked) {
              status = options[i].value;
              break;
            }
          }

          let myHeaders = new Headers();
          myHeaders.append('Content-Type', 'application/json');
          let payload = {
            profile_url: selectedImage,
            name: botName.value,
            status: status,
            brains: selected,
            mouths: mouths,
            history: [],
          };
          let myBody = JSON.stringify(payload);
          let myInit = { 
            method: 'POST',
            headers: myHeaders,
            body: myBody,
          };
          let myURL = "http://localhost:3000/";

          //launch the request
          fetch(myURL,myInit)
          .then((httpResponse)=>{
            return httpResponse.text();
          })
          .then((responseBody)=>{
            reloadBotList();
            //clear fields

            console.log(`response is ${responseBody}`);
          })
          .catch((err)=>{
            console.log(`ERROR : ${err}`);
          })
        }

        function addBot(bot, active, num) {

          let parentDiv = document.createElement('div');
          parentDiv.className = "carousel-item " + active;
          
          let childDiv = document.createElement('div');
          childDiv.className = "container2";

          let rowDiv = document.createElement('div');
          rowDiv.className = "row";

          let imageDiv = document.createElement('div');
          imageDiv.className = "col-md-6";

          let profile_img = document.createElement('img');
          profile_img.src = "/images/" + bot.profile_url;
          profile_img.className = "img-fluid";
          profile_img.alt = "Profile pic";

          imageDiv.append(profile_img);

          rowDiv.append(imageDiv);

          let parent_info_box = document.createElement('div');
          parent_info_box.className = "col-md-6";

          let button_div = document.createElement('div');
          button_div.className = "buttons_header";

          let modify_button = document.createElement('button');
          modify_button.className = "edit-button";
          modify_button.addEventListener('click', () => {updateBot()});
          
          let modify_icon = document.createElement('i');
          modify_icon.className = "fas fa-pencil-alt";

          modify_button.append(modify_icon);

          let delete_button = document.createElement('button');
          delete_button.className = "delete-button";
          delete_button.addEventListener('click', () => {deleteBot(bot.id)});

          let delete_icon = document.createElement('i');
          delete_icon.className = "fas fa-trash-alt";

          delete_button.append(delete_icon);

          button_div.append(modify_button);
          button_div.append(delete_button);
          parent_info_box.append(button_div);

          let info_box = document.createElement('div');
          info_box.className = "info-box";

          let br = document.createElement('br');

          info_box.append(br);

          let bot_name = document.createElement('h2');
          bot_name.textContent = bot.name;

          info_box.append(bot_name);
          
          let status = document.createElement('p');
          status.textContent = "Status: active";

          info_box.append(status);

          let brains = document.createElement('p');
          brains.textContent = "Brains: ";

          info_box.append(brains);

          let brain_list = document.createElement('ul');
          for(let i = 0; i < bot.brains.length; i++) {
            let brain_item = document.createElement('li');
            brain_item.textContent = bot.brains[i];
            brain_list.append(brain_item);
          }

          info_box.append(brain_list);

          let mouths = document.createElement('p');
          mouths.textContent = "Mouths: ";

          info_box.append(mouths);

          let mouths_container = document.createElement('div');
          mouths_container.className = "mouths_container";

          for(let i = 0; i < bot.mouths.length; i++) {
            let img = document.createElement('img');
            img.src = "/images/" + bot.mouths[i] + ".png";
            img.className = "mouth";
            img.alt = bot.mouths[i];

            mouths_container.append(img);
          }

          info_box.append(mouths_container);

          parent_info_box.append(info_box);

          rowDiv.append(parent_info_box);

          childDiv.append(rowDiv);

          parentDiv.append(childDiv);

          //append the brand new bot div to the carousel
          botList.append(parentDiv);

          //add also the indicator
          let indicators = document.querySelector('.carousel-indicators');
          let item = document.createElement('li');
          item.dataset.target = '#carouselIndicators';
          item.dataset.slideTo = num;
          item.className = active;

          indicators.append(item);
        }

        function reloadBotList() {

          while (botList.firstChild) {
            botList.removeChild(botList.firstChild);
          }

          let myHeaders = new Headers();
          myHeaders.append('Content-Type', 'application/json');

          let myInit = { 
            method: 'GET',
                    headers: myHeaders,
                    cache: 'default' 
                };

          let myURL = `http://localhost:3000/`;

          fetch(myURL,myInit)
            .then((httpResponse)=>{
              return httpResponse.json()
            })
            .then((data)=>{
              let setOfBots = data.bots;
              let isAdmin = data.admin;
              const formContainer = document.querySelector('.creation-form');
              const logout_button = document.getElementById('logout-link');
              const login_button = document.getElementById('login-link');
              if (isAdmin) {
                formContainer.style.display = 'block';
                logout_button.style.display = 'block';
                login_button.style.display = 'none';
              } else {
                formContainer.style.display = 'none';
                logout_button.style.display = 'none';
                login_button.style.display = 'block';
              }
              if(setOfBots.length != 0) {
                let first = true;
                i = 1;
                for(let bot of setOfBots){
                  if(first == true) {
                    addBot(bot,"active", "0");
                    first = false;
                  } else {
                    addBot(bot, "", i);
                    i++;
                  }
                }
              } else {
                let div = document.getElementById('carouselIndicators')
                div.innerHTML = "";
                let noBot = document.createElement('p');
                noBot.textContent = "No bot has been created yet."

                div.append(noBot);
              }
            })
            .catch((err)=>{
              console.log(`ERROR : ${err}`);
            })
        }

        function deleteBot(botId) {
          let myHeaders = new Headers();
          myHeaders.append('Content-Type', 'application/json');

          let myInit = { 
            method: 'DELETE',
            headers: myHeaders,
          };

          let myURL = `http://localhost:3000/${botId}`;
          fetch(myURL,myInit)
            .then((httpResponse)=>{
              return httpResponse.text()
            })
            .then((returnString)=>{
              reloadBotList();
              console.log(`All is OK ${returnString}`)
            })
            .catch((err)=>{
              console.log(`ERROR : ${err}`);
            })
        }

        function updateBot() {
          console.log("I will update this bot");
        }

        function init() {
          botList = document.querySelector('.carousel-inner');
          chosen_image1 = document.getElementById('image1');
          chosen_image2 = document.getElementById('image2');
          chosen_image3 = document.getElementById('image3');
          chosen_image4 = document.getElementById('image4');
          chosen_image5 = document.getElementById('image5');
          botName = document.getElementById('bot-name');
          const logoutLink = document.getElementById('logout-link');
          logoutLink.addEventListener('click', async (event) => {
            event.preventDefault(); 
      
            fetch('/logout', { method: 'POST' })
              .then(()=>{
                console.log("Redirecting to login page...")
                window.location.href = '/static/login.html';
              })
              .catch((err)=>{
                console.error(`Server responded with status ${err}`);
              });
          });
          selected = [];

          createNewBotButton = document.querySelector('.create-button');
          createNewBotButton.addEventListener('click', createNewBot);

          manageFilesInCreation();
          reloadBotList();
        }
    </script>
</html>